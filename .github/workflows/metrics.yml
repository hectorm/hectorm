name: 'Metrics'

on:
  push:
    branches: ['*']
    paths: ['.github/workflows/metrics.yml']
  pull_request:
    branches: ['*']
    paths: ['.github/workflows/metrics.yml']
  schedule:
    - cron: '55 05 * * *'
  workflow_dispatch:

concurrency:
  group: '${{ github.ref }}'
  cancel-in-progress: true

jobs:

  generate-metrics:
    name: 'Generate metrics'
    runs-on: 'ubuntu-latest'
    permissions: {}
    steps:
      - uses: 'lowlighter/metrics@v3.23'
        with:
          # Core
          config_animations: true
          config_base64: true
          config_display: 'regular'
          config_order: 'base.header, base.repositories, languages, notable, achievements'
          config_output: 'svg'
          config_padding: '0, 16%'
          config_timezone: 'UTC'
          experimental_features: '--optimize-svg'
          filename: 'metrics.*'
          optimize: 'css, xml, svg'
          output_action: 'none'
          template: 'classic'
          token: '${{ secrets.METRICS_TOKEN }}'
          user: '${{ github.repository_owner }}'
          # Base
          base: 'header, repositories'
          base_indepth: true
          repositories: 200
          repositories_forks: false
          # Achievements plugin
          plugin_achievements: true
          plugin_achievements_display: 'compact'
          plugin_achievements_secrets: true
          plugin_achievements_threshold: 'B'
          # Most used languages plugin
          plugin_languages: true
          plugin_languages_analysis_timeout: 15
          plugin_languages_categories: 'markup, programming'
          plugin_languages_colors: 'github'
          plugin_languages_indepth: false
          plugin_languages_limit: 8
          plugin_languages_other: false
          plugin_languages_sections: 'most-used'
          plugin_languages_threshold: '0%'
          # Notable contributions plugin
          plugin_notable: true
          plugin_notable_from: 'all'
          plugin_notable_indepth: false
          plugin_notable_repositories: true
          plugin_notable_types: 'commit'
      - name: 'Upload artifacts'
        uses: 'actions/upload-artifact@v3'
        with:
          name: 'metrics'
          path: '/metrics_renders/'
          retention-days: 1

  publish-metrics:
    name: 'Publish metrics'
    if: "github.ref == 'refs/heads/master'"
    needs: ['generate-metrics']
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'write'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@v3'
        with:
          ref: '${{ github.ref }}'
      - name: 'Download artifacts'
        uses: 'actions/download-artifact@v3'
        with:
          name: 'metrics'
          path: './metrics/'
      - name: 'Publish'
        run: |
          git config --global user.name 'hectorm-bot'
          git config --global user.email 'noreply@molinero.dev'
          if [ -n "$(git status --porcelain=v1 ./metrics/)" ]; then
            git add ./metrics/
            git commit -m "[skip ci] Metrics $(date -Iseconds)"
            git push
          fi
